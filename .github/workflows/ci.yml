# ========================================
# SIMPLE CI PIPELINE - Learning Version
# ========================================
# What: Automated checks on every push
# Why: Catch bugs before they reach production
# When: Runs automatically on git push OR manually triggered

name:  CI

on:
  push:
    branches: [ main, develop, feature/* ]
    paths-ignore:
      - 'helm-chart/**'           # Ignore Helm chart changes to prevent recursion
      - 'k8s-manifest/**'         # Ignore K8s manifests
      - '*.md'                    # Ignore documentation
      - '.gitignore'              # Ignore config files
  pull_request:
    branches: [ main, develop, feature/* ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: false
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production
      skip_tests:
        description: 'Skip integration tests'
        required: false
        default: false
        type: boolean


jobs:
  
  check-python:
    name: Check Python Code
    runs-on: ubuntu-latest
    
    steps:
      # Show manual trigger info (if applicable)
      - name: Workflow Info
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "=========================================="
          echo "ðŸš€ MANUALLY TRIGGERED WORKFLOW"
          echo "=========================================="
          echo "Environment: ${{ inputs.environment }}"
          echo "Skip Tests: ${{ inputs.skip_tests }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "=========================================="
      
      # Step 1: Get code from GitHub
      - name: Get Code
        uses: actions/checkout@v4
      
      # Step 2: Install Python
      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      # Step 3: Install packages
      - name: Install Packages
        run: |
          pip install -r requirements.txt
      
      # Step 5: Run tests
      - name: Run Tests
        run: |
          pip install pytest
          pytest tests/ --verbose || echo "No tests yet"
  

  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Get Code
        uses: actions/checkout@v4
      
      # ========================================
      # BACKEND IMAGE
      # ========================================
      - name: Build Backend
        run: |
          docker build -t connecthub-backend .
          echo "Backend image built successfully"
      
      - name: Test Backend Image Runs
        run: |
          echo "Testing: Can backend container start?"
          docker run --rm connecthub-backend python --version
          echo "Backend container can execute commands"
      
      - name: Verify Backend Image Structure
        run: |
          docker run --rm connecthub-backend ls -la /app
          echo "Backend app files exist"
      
      - name: Save Backend Docker Image
        run: |
          echo "Saving backend image to tar file..."
          docker save connecthub-backend:latest -o backend-image.tar
          echo "Backend image saved: $(du -h backend-image.tar)"
      
      - name: Upload Backend Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-docker-image
          path: backend-image.tar
          retention-days: 2
    
      # ========================================
      # FRONTEND IMAGE
      # ========================================
      - name: Build Frontend
        run: |
          docker build -t connecthub-frontend ./frontend-service
          echo "Frontend image built successfully"
      
      - name: Save Frontend Docker Image
        run: |
          echo "Saving frontend image to tar file as artifact"
          docker save connecthub-frontend:latest -o frontend-image.tar
          echo "Frontend image saved: $(du -h frontend-image.tar)"
      
      - name: Upload Frontend Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-docker-image
          path: frontend-image.tar
          retention-days: 2



  # ============================================
  # JOB 3: Integration Test (Real Services)
  # ============================================
  # WHY: Test app with actual database, redis, rabbitmq
  # CATCHES: Connection issues, config errors, missing env vars
  # TARGET: Ensure app works before deploying to K8s
  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: build-image  # Only run if build-image passes
    # Skip if manually triggered with skip_tests=true
    if: ${{ !inputs.skip_tests }}
    
    steps:
      - name: Get Code
        uses: actions/checkout@v4
      
      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Start all services using docker compose (V2 plugin)
      - name: Start Services
        run: |
          echo "Starting: PostgreSQL, Redis, RabbitMQ, Backend..."
          docker compose up -d --build
          echo "Waiting 60s for services to be ready..."
          sleep 60
      
      # Check all containers are running
      - name: Check Services Status
        run: |
          echo "=== Running Containers ==="
          docker ps
          echo ""
          echo "=== Container Health ==="
          docker ps --format "table {{.Names}}\t{{.Status}}"
      
      # Test health endpoints (like Kubernetes will)
      - name: Test Health Endpoint
        run: |
          echo "Testing: /health endpoint (liveness probe)"
          curl -f http://localhost:5000/health || exit 1
          echo "Health check passed"
      
      - name: Test Ready Endpoint
        run: |
          echo "Testing: /ready endpoint (readiness probe)"
          curl -f http://localhost:5000/ready || exit 1
          echo "Readiness check passed"
      
      # Test actual API functionality
      - name: Test API Endpoints
        run: |
          echo "Testing: API root endpoint"
          curl -f http://localhost:5000/ | grep "ConnectHub" || exit 1
          echo "API is responding"
      
      # Show logs if something fails
      - name: Show Logs (if failure)
        if: failure()
        run: |
          echo "=== Backend Logs ==="
          docker logs connecthub-backend-api
          echo ""
          echo "=== Database Logs ==="
          docker logs connecthub-database
      
      # Always cleanup
      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
          echo "Services stopped and cleaned"


  # ========================================
  # PUSH TO DOCKER HUB (main branch only)
  # ========================================
  push-image:
    name: Push Image to Docker Hub
    runs-on: ubuntu-latest
    needs: [check-python, build-image, integration-test]
    # Only run on main branch (not on feature branches or PRs)
    if: github.ref == 'refs/heads/main'
    
    # Grant write permission to push commits back to repo
    permissions:
      contents: write  # Allows git push
    
    steps:
      - name: Get Code
        uses: actions/checkout@v4
      
      # Login to Docker Hub docker compose image pull
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      # Build and tag backend with commit SHA
      - name: Build and Tag Backend Image
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          docker build -t tomernos/connecthub-backend:$SHORT_SHA .
          echo "Built: tomernos/connecthub-backend:$SHORT_SHA"
      
      # Build and tag frontend with commit SHA
      - name: Build and Tag Frontend Image
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          docker build -t tomernos/connecthub-frontend:$SHORT_SHA ./frontend-service
          echo "Built: tomernos/connecthub-frontend:$SHORT_SHA"
      
      # Push both images to Docker Hub
      - name: Push Images to Docker Hub
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "Pushing backend..."
          docker push tomernos/connecthub-backend:$SHORT_SHA
          echo "Pushing frontend..."
          docker push tomernos/connecthub-frontend:$SHORT_SHA
          echo "âœ… Both images pushed successfully!"
          echo ""
          echo "View at:"
          echo "  https://hub.docker.com/r/tomernos/connecthub-backend/tags"
          echo "  https://hub.docker.com/r/tomernos/connecthub-frontend/tags"

      - name: Update Helm Chart Values
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          
          # Only update backend and frontend tags (not redis, postgres, rabbitmq!)
          # Update backend tag (line containing "tomernos/connecthub-backend" then next tag)
          sed -i "/tomernos\/connecthub-backend/,/tag:/ s/tag: .*/tag: $SHORT_SHA/" helm-chart/values.yaml
          
          # Update frontend tag
          sed -i "/tomernos\/connecthub-frontend/,/tag:/ s/tag: .*/tag: $SHORT_SHA/" helm-chart/values.yaml
          
          echo "âœ… Updated backend and frontend tags to: $SHORT_SHA"

      # Step 4: Commit the updated file
      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update image tags to ${{ github.sha }}"
          file_pattern: 'helm-chart/values.yaml'