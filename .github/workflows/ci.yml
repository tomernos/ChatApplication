# ========================================
# CI PIPELINE - Build, Test, Create Artifacts
# ========================================
# What: Build Docker images, run tests, upload artifacts
# Why: Ensure code quality before deployment
# When: Every push to main/develop/feature branches

name: CI

on:
  push:
    branches: [ main, develop, feature/*, hotfix/* ]
    paths-ignore:
      - 'helm-chart/**'           # Ignore Helm chart changes to prevent recursion
      - 'k8s-manifest/**'         # Ignore K8s manifests
      - '*.md'                    # Ignore documentation
      - '.gitignore'              # Ignore config files
  pull_request:
    branches: [ main, develop, feature/* ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: false
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production
      skip_tests:
        description: 'Skip integration tests'
        required: false
        default: false
        type: boolean


jobs:
  # ==================
  # JOB 1: Python Test 
  # ==================
  check-python:
    name: Check Python Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Workflow Info
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "=========================================="
          echo "ðŸš€ MANUALLY TRIGGERED WORKFLOW"
          echo "=========================================="
          echo "Environment: ${{ inputs.environment }}"
          echo "Skip Tests: ${{ inputs.skip_tests }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "=========================================="
      
      - name: Get Code
        uses: actions/checkout@v4
      
      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install Packages
        run: |
          pip install -r requirements.txt
      
      - name: Run Tests
        run: |
          pip install pytest
          pytest tests/ --verbose || echo "No tests yet"
  
  # =======================
  # JOB 2: Build Images 
  # =======================
  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Get Code
        uses: actions/checkout@v4
      
      # =============
      # BACKEND IMAGE
      # =============
      - name: Build Backend
        run: |
          docker build -t connecthub-backend .
          echo "Backend image built successfully"
      
      - name: Test Backend Image Runs
        run: |
          echo "Testing: Can backend container start?"
          docker run --rm connecthub-backend python --version
          echo "Backend container can execute commands"
      
      - name: Verify Backend Image Structure
        run: |
          docker run --rm connecthub-backend ls -la /app
          echo "Backend app files exist"
      
      - name: Save Backend Docker Image
        run: |
          echo "Saving backend image to tar file..."
          docker save connecthub-backend:latest -o backend-image.tar
          echo "Backend image saved: $(du -h backend-image.tar)"
      
      - name: Upload Backend Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-docker-image
          path: backend-image.tar
          retention-days: 2
    
      # ==============
      # FRONTEND IMAGE
      # ==============
      - name: Build Frontend
        run: |
          docker build -t connecthub-frontend ./frontend-service
          echo "Frontend image built successfully"
      
      - name: Save Frontend Docker Image
        run: |
          echo "Saving frontend image to tar file as artifact"
          docker save connecthub-frontend:latest -o frontend-image.tar
          echo "Frontend image saved: $(du -h frontend-image.tar)"
      
      - name: Upload Frontend Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-docker-image
          path: frontend-image.tar
          retention-days: 2

  # =======================
  # JOB 3: Integration Test 
  # =======================
  integration-test:
    name: Integration Test
    needs: build-image
    runs-on: ubuntu-latest
    # Skip if manually triggered with skip_tests=true
    if: ${{ !inputs.skip_tests }}
    
    steps:
      - name: Get Code
        uses: actions/checkout@v4
      
      # ==================
      # DOWNLOAD ARTIFACTS
      # ==================
      - name: Download Backend Image
        uses: actions/download-artifact@v4
        with:
          name: backend-docker-image
          path: /tmp
    
      - name: Download Frontend Image
        uses: actions/download-artifact@v4
        with:
          name: frontend-docker-image
          path: /tmp
    
      # ==================
      # LOAD DOCKER IMAGES
      # ==================
      - name: Load Backend Image
        run: |
          echo "Loading backend image from artifact..."
          docker load -i /tmp/backend-image.tar
          docker images | grep connecthub-backend
          echo "âœ… Backend image loaded"
    
      - name: Load Frontend Image
        run: |
          echo "Loading frontend image from artifact..."
          docker load -i /tmp/frontend-image.tar
          docker images | grep connecthub-frontend
          echo "âœ… Frontend image loaded"
    
      # ========================================
      # ðŸ†• TAG IMAGES TO MATCH DOCKER-COMPOSE
      # ========================================
      - name: Tag Images for docker-compose
        run: |
          # Tag backend with the exact name docker-compose expects
          docker tag connecthub-backend:latest tomernos/connecthub-backend:latest
          
          # Tag frontend with the exact name docker-compose expects
          docker tag connecthub-frontend:latest tomernos/connecthub-frontend:latest
          
          echo "âœ… Images tagged for docker-compose"
          docker images | grep connecthub
    
      # ========================================
      # START SERVICES (NO REBUILD!)
      # ========================================
      - name: Start Services
        run: |
          echo "Starting services with docker-compose"
          docker compose up -d
          echo "Waiting for containers to start..."
          sleep 10
          docker compose ps
    
      # ========================================
      # WAIT FOR HEALTH CHECKS
      # ========================================
      - name: Wait for Services to be Healthy
        run: |
          echo "=== Running Containers ==="
          docker ps
          echo ""
          echo "=== Container Health ==="
          docker ps --format "table {{.Names}}\t{{.Status}}"
      
      # Test health endpoints (like Kubernetes will)
      - name: Test Health Endpoint
        run: |
          echo "Testing backend health endpoint..."
          curl -f http://localhost:5000/health || exit 1
          echo "Health check passed"
      
      - name: Test Ready Endpoint
        run: |
          echo "Testing: /ready endpoint (readiness probe)"
          curl -f http://localhost:5000/ready || exit 1
          echo "Readiness check passed"
      
      # Test actual API functionality
      - name: Test API Endpoints
        run: |
          echo "Testing: API root endpoint"
          curl -f http://localhost:5000/ | grep "ConnectHub" || exit 1
          echo "API is responding"
      
      # Show logs if something fails
      - name: Show Logs (if failure)
        if: failure()
        run: |
          echo "=== Backend Logs ==="
          docker logs connecthub-backend-api
          echo ""
          echo "=== Database Logs ==="
          docker logs connecthub-database
      
      # Always cleanup
      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
          echo "Services stopped and cleaned"


